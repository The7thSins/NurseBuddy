<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NurseBuddy | ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà ${bedId}</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      min-height: 100vh;
      padding: 10px;
    }

    .header {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
    }

    .header h1 {
      font-size: 24px;
      margin: 0;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }

    .nav-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 12px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .nav-btn:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }

    .nav-btn:active {
      transform: translateY(0);
    }

    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 15px;
      }

      .nav-buttons {
        width: 100%;
        justify-content: center;
      }
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(14, 165, 233, 0.1);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f5f9;
    }

    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .status-item {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .status-item:hover {
      border-color: #0ea5e9;
      transform: translateY(-2px);
    }

    .status-value {
      font-size: 24px;
      font-weight: 700;
      color: #0ea5e9;
      margin-bottom: 8px;
    }

    .status-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
    }

    .patient-info {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border: 2px solid #22c55e;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .patient-info:hover {
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
    }

    .patient-info h3 {
      color: #166534;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .patient-detail {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 14px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .quick-btn {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      border: none;
      padding: 18px 15px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-height: 80px;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);
    }

    .quick-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
    }

    .quick-btn:active {
      transform: translateY(-1px);
    }

    .quick-btn.secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      box-shadow: 0 4px 15px rgba(100, 116, 139, 0.2);
    }

    .quick-btn.secondary:hover {
      box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
    }

    .quick-btn.danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
    }

    .quick-btn.danger:hover {
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }

    .quick-btn-icon {
      font-size: 24px;
    }

    .quick-btn-text {
      font-size: 12px;
      line-height: 1.2;
    }

    @media (max-width: 480px) {
      .quick-actions {
        grid-template-columns: 1fr;
      }

      .quick-btn {
        flex-direction: row;
        min-height: 60px;
        gap: 12px;
      }

      .quick-btn-icon {
        font-size: 20px;
      }

      .quick-btn-text {
        font-size: 14px;
      }
    }

    .chart-container {
      height: 300px;
      margin-bottom: 20px;
      background: #f8fafc;
      border-radius: 12px;
      padding: 15px;
      border: 2px solid #e2e8f0;
    }

    .notes-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(14, 165, 233, 0.1);
    }

    .note-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      resize: vertical;
      min-height: 100px;
      margin-bottom: 15px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .note-input:focus {
      border-color: #0ea5e9;
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .add-note-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
    }

    .add-note-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
    }

    .note-item {
      background: #f8fafc;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      border-left: 4px solid #0ea5e9;
      transition: all 0.3s ease;
    }

    .note-item:hover {
      background: #f1f5f9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .note-author {
      font-size: 12px;
      font-weight: 600;
      color: #0ea5e9;
    }

    .note-time {
      font-size: 11px;
      color: #64748b;
    }

    .note-content {
      font-size: 14px;
      color: #374151;
      line-height: 1.5;
    }

    .vital-signs {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .vital-signs h3 {
      color: #92400e;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .vital-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .vital-item {
      background: rgba(255,255,255,0.8);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .vital-value {
      font-size: 18px;
      font-weight: 700;
      color: #92400e;
    }

    .vital-label {
      font-size: 11px;
      color: #78350f;
      margin-top: 4px;
    }

    .medication-schedule {
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      border: 2px solid #6366f1;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .medication-schedule h3 {
      color: #3730a3;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .med-item {
      background: rgba(255,255,255,0.9);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .med-name {
      font-weight: 600;
      color: #3730a3;
    }

    .med-time {
      font-size: 12px;
      color: #6366f1;
    }

    .alerts-section {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border: 2px solid #ef4444;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
    }

    .alerts-section.active {
      display: block;
    }

    .alert-item {
      background: rgba(255,255,255,0.9);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-icon {
      font-size: 20px;
      color: #ef4444;
    }

    .alert-text {
      color: #991b1b;
      font-weight: 500;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #1e293b;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f5f9;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 5px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      border-color: #0ea5e9;
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 480px) {
      .input-row {
        grid-template-columns: 1fr;
      }

      .vital-grid {
        grid-template-columns: 1fr;
      }

      .status-grid {
        grid-template-columns: 1fr;
      }
    }

    .calculation-result {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0ea5e9;
      padding: 20px;
      border-radius: 12px;
      margin-top: 15px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(14, 165, 233, 0.1);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-value {
      font-weight: 700;
      color: #0ea5e9;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
      font-style: italic;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #64748b;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #0ea5e9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* New styles for IV Calculator */
    .iv-calculator-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(14, 165, 233, 0.1);
      margin-bottom: 20px;
    }

    .calc-mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .calc-mode-btn {
      background: #f1f5f9;
      color: #475569;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .calc-mode-btn.active {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }

    .calc-mode {
      display: none;
    }

    .calc-mode.active {
      display: block;
    }

    .calc-button {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .iv-results {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      background: #f8fafc;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .save-calc-btn {
      background: #64748b;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .time-tracking {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      background: #f8fafc;
    }

    .tracking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .refresh-time-btn {
      background: #64748b;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Auto IV Calculator Styles */
    .auto-calc-info {
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      border-radius: 12px;
      border: 1px solid #0ea5e9;
    }

    .info-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #0c4a6e;
      font-weight: 500;
    }

    .info-icon {
      font-size: 16px;
    }

    .patient-calc-data {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #f1f5f9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .calc-data-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .calc-data-row:last-child {
      margin-bottom: 0;
    }

    .calc-data-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .calc-data-item input,
    .calc-data-item select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .calc-data-item input:focus,
    .calc-data-item select:focus {
      border-color: #0ea5e9;
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .medication-display {
      padding: 12px 15px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      color: #64748b;
      font-style: italic;
    }

    .auto-calc-results {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #0ea5e9;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .result-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
    }

    .result-card.estimated-finish {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-color: #f59e0b;
    }

    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .result-icon {
      font-size: 32px;
      min-width: 40px;
      text-align: center;
    }

    .result-content {
      flex: 1;
    }

    .result-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .result-value {
      font-size: 18px;
      font-weight: 700;
      color: #0ea5e9;
    }

    .estimated-finish .result-value {
      color: #92400e;
    }

    .time-tracking-live {
      background: white;
      border-radius: 15px;
      padding: 20px;
      border: 2px solid #22c55e;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .tracking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }

    .tracking-header h4 {
      margin: 0;
      color: #166534;
      font-size: 16px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #166534;
      font-weight: 500;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    .status-dot.active {
      background: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .tracking-content {
      font-size: 14px;
      color: #374151;
    }

    .tracking-message {
      text-align: center;
      color: #64748b;
      font-style: italic;
      padding: 20px;
    }

    .countdown-display {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #166534;
      padding: 20px;
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .countdown-display.warning {
      color: #92400e;
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
    }

    .countdown-display.urgent {
      color: #991b1b;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      animation: warningPulse 1s ease-in-out infinite;
    }

    @keyframes warningPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes slideIn {
      from { 
        transform: translateX(100%); 
        opacity: 0;
      }
      to { 
        transform: translateX(0); 
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from { 
        transform: translateX(0); 
        opacity: 1;
      }
      to { 
        transform: translateX(100%); 
        opacity: 0;
      }
    }

    @keyframes bounceIn {
      0% { 
        transform: translateY(100%) scale(0.8); 
        opacity: 0;
      }
      50% { 
        transform: translateY(-10px) scale(1.05); 
        opacity: 1;
      }
      100% { 
        transform: translateY(0) scale(1); 
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from { 
        opacity: 1; 
        transform: scale(1);
      }
      to { 
        opacity: 0; 
        transform: scale(0.9);
      }
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-fill.warning {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .progress-fill.urgent {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    @media (max-width: 768px) {
      .calc-data-row {
        grid-template-columns: 1fr;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }

      .tracking-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="bedTitle">üè• ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà 1</h1>
    <div class="nav-buttons">
      <button class="nav-btn" onclick="window.location.href='dashboard.html'">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
      <button class="nav-btn" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å</button>
    </div>
  </div>

  <div class="main-content">
    <div class="card">
      <div class="card-title">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>

      <div class="status-grid">
        <div class="status-item">
          <div class="status-value" id="currentFlow">0</div>
          <div class="status-label">‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="orderedFlow">0</div>
          <div class="status-label">‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á)</div>
        </div>
      </div>

      <div id="patientInfo" class="patient-info" style="display: none;">
        <h3>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
        <div class="patient-detail">
          <div><strong>‡∏£‡∏´‡∏±‡∏™:</strong> <span id="patientId">-</span></div>
          <div><strong>‡∏¢‡∏≤:</strong> <span id="medication">-</span></div>
          <div><strong>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì:</strong> <span id="volume">-</span></div>
          <div><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤:</strong> <span id="rate">-</span></div>
        </div>
      </div>

      <div id="vitalSigns" class="vital-signs" style="display: none;">
        <h3>ü©∫ Vital Signs</h3>
        <div class="vital-grid">
          <div class="vital-item">
            <div class="vital-value" id="bloodPressure">120/80</div>
            <div class="vital-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</div>
          </div>
          <div class="vital-item">
            <div class="vital-value" id="heartRate">72</div>
            <div class="vital-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à</div>
          </div>
          <div class="vital-item">
            <div class="vital-value" id="temperature">36.5¬∞C</div>
            <div class="vital-label">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
          </div>
          <div class="vital-item">
            <div class="vital-value" id="oxygenSat">98%</div>
            <div class="vital-label">‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</div>
          </div>
        </div>
      </div>

      <div id="medicationSchedule" class="medication-schedule" style="display: none;">
            <h3>üíä ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤</h3>
            <div id="medList">
              <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
          </div>

          <!-- IV Calculator Section -->
          <div class="iv-calculator-section">
            <div class="card-title">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠</div>

            <div class="auto-calc-info">
              <div class="info-badge">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
              </div>
            </div>

            <!-- Patient Data Display -->
            <div id="patientCalcData" class="patient-calc-data">
              <div class="calc-data-row">
                <div class="calc-data-item">
                  <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ (mL):</label>
                  <input type="number" id="autoVolume" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" min="1" oninput="calculateAutoIV()">
                </div>
                <div class="calc-data-item">
                  <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏î (‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ):</label>
                  <input type="number" id="autoRate" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢" min="1" oninput="calculateAutoIV()">
                </div>
              </div>
              <div class="calc-data-row">
                <div class="calc-data-item">
                  <label>Drop Factor:</label>
                  <select id="autoDropFactor" onchange="calculateAutoIV()">
                    <option value="10">10 ‡∏´‡∏¢‡∏î/cc (‡πÄ‡∏î‡πá‡∏Å)</option>
                    <option value="15">15 ‡∏´‡∏¢‡∏î/cc</option>
                    <option value="20" selected>20 ‡∏´‡∏¢‡∏î/cc (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</option>
                    <option value="60">60 ‡∏´‡∏¢‡∏î/cc (Micro set)</option>
                  </select>
                </div>
                <div class="calc-data-item">
                  <label>‡∏¢‡∏≤/‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≥:</label>
                  <div id="medicationType" class="medication-display">-</div>
                </div>
              </div>
            </div>

            <!-- Results Display - Always Visible -->
            <div id="autoCalcResults" class="auto-calc-results">
              <div class="results-grid">
                <div class="result-card">
                  <div class="result-icon">‚ö°</div>
                  <div class="result-content">
                    <div class="result-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•</div>
                    <div class="result-value" id="flowRate">0 cc/hr</div>
                  </div>
                </div>
                <div class="result-card">
                  <div class="result-icon">‚è∞</div>
                  <div class="result-content">
                    <div class="result-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏´‡∏°‡∏î</div>
                    <div class="result-value" id="finishTime">0 ‡∏ä‡∏°. 0 ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                  </div>
                </div>
                <div class="result-card">
                  <div class="result-icon">üíß</div>
                  <div class="result-content">
                    <div class="result-label">‡∏´‡∏¢‡∏î‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    <div class="result-value" id="dropPerSec">0 ‡∏î‡∏£‡∏≠‡∏õ/‡∏ß‡∏¥</div>
                  </div>
                </div>
                <div class="result-card estimated-finish">
                  <div class="result-icon">üïê</div>
                  <div class="result-content">
                    <div class="result-label">‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div>
                    <div class="result-value" id="estimatedFinish">-</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Time Tracking Display -->
            <div id="timeTrackingDisplay" class="time-tracking-live">
              <div class="tracking-header">
                <h4>‚è∞ ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</h4>
                <div class="status-indicator" id="trackingStatus">
                  <div class="status-dot"></div>
                  <span>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</span>
                </div>
              </div>
              <div id="timeTrackingContent" class="tracking-content">
                <div class="tracking-message">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</div>
              </div>
            </div>
          </div>

      <div id="alertsSection" class="alerts-section">
        <h3>üö® ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
        <div id="alertsList">
          <!-- ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </div>
      </div>

      <div class="quick-actions">
        <button class="quick-btn" onclick="showPatientModal()">
          <div class="quick-btn-icon">üë§</div>
          <div class="quick-btn-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
        </button>
        <button class="quick-btn" onclick="showIOModal()">
          <div class="quick-btn-icon">üíß</div>
          <div class="quick-btn-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O</div>
        </button>
        <button class="quick-btn" onclick="showVitalModal()">
          <div class="quick-btn-icon">ü©∫</div>
          <div class="quick-btn-text">Vital Signs</div>
        </button>
        <button class="quick-btn secondary" onclick="showCalcModal()">
          <div class="quick-btn-icon">üßÆ</div>
          <div class="quick-btn-text">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>
        </button>
        <button class="quick-btn secondary" onclick="showMedModal()">
          <div class="quick-btn-icon">üíä</div>
          <div class="quick-btn-text">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div>
        </button>
        <button class="quick-btn danger" onclick="resetBedData()">
          <div class="quick-btn-icon">üóëÔ∏è</div>
          <div class="quick-btn-text">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</div>
        </button>
      </div>

      <div class="chart-container">
        <canvas id="flowChart"></canvas>
      </div>
    </div>

    <div class="notes-section">
      <div class="card-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•</div>
      <textarea class="note-input" id="noteInput" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..."></textarea>
      <button class="add-note-btn" onclick="addNote()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <div id="notesList">
        <div class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
      </div>
    </div>
  </div>

  <!-- Patient Modal -->
  <div class="modal" id="patientModal">
    <div class="modal-content">
      <div class="modal-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
      <div class="input-group">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
        <input type="text" id="modalPatientId" placeholder="P001234">
      </div>
      <div class="input-group">
        <label>‡∏¢‡∏≤/‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≥:</label>
```text

        <select id="modalMedication">
          <option value="Normal Saline">Normal Saline (0.9% NSS)</option>
          <option value="Dextrose 5%">Dextrose 5% in Water</option>
          <option value="Lactated Ringer's">Lactated Ringer's Solution</option>
          <option value="Dextrose 5% in NSS">D5NSS</option>
          <option value="Half Normal Saline">0.45% NSS</option>
        </select>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (mL):</label>
          <input type="number" id="modalVolume" placeholder="500">
        </div>
        <div class="input-group">
          <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ):</label>
          <input type="number" id="modalRate" placeholder="20">
        </div>
      </div>
      <button class="btn btn-success" onclick="savePatientData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-secondary" onclick="closeModal('patientModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <!-- I/O Modal -->
  <div class="modal" id="ioModal">
    <div class="modal-content">
      <div class="modal-title">üíß ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Input/Output</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h4 style="color: #22c55e; margin-bottom: 15px;">üì• INPUT</h4>
          <div class="input-group">
            <label>‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏° (mL):</label>
            <input type="number" id="inputWater" placeholder="0">
          </div>
          <div class="input-group">
            <label>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏ß (mL):</label>
            <input type="number" id="inputFood" placeholder="0">
          </div>
          <div class="input-group">
            <label>‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ IV (mL):</label>
            <input type="number" id="inputIV" placeholder="0">
          </div>
          <div class="input-group">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏î (mL):</label>
            <input type="number" id="inputBlood" placeholder="0">
          </div>
        </div>
        <div>
          <h4 style="color: #ef4444; margin-bottom: 15px;">üì§ OUTPUT</h4>
          <div class="input-group">
            <label>‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ (mL):</label>
            <input type="number" id="outputUrine" placeholder="0">
          </div>
          <div class="input-group">
            <label>‡∏≠‡∏≤‡πÄ‡∏à‡∏µ‡∏¢‡∏ô (mL):</label>
            <input type="number" id="outputVomit" placeholder="0">
          </div>
          <div class="input-group">
            <label>Drain (mL):</label>
            <input type="number" id="outputDrain" placeholder="0">
          </div>
          <div class="input-group">
            <label>‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡πÄ‡∏´‡∏•‡∏ß (mL):</label>
            <input type="number" id="outputStool" placeholder="0">
          </div>
        </div>
      </div>
      <div id="ioResult" class="calculation-result" style="display: none;"></div>
      <button class="btn btn-primary" onclick="calculateIO()">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
      <button class="btn btn-success" onclick="saveIOData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-secondary" onclick="closeModal('ioModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <!-- Vital Signs Modal -->
  <div class="modal" id="vitalModal">
    <div class="modal-content">
      <div class="modal-title">ü©∫ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vital Signs</div>
      <div class="input-row">
        <div class="input-group">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï (Systolic):</label>
          <input type="number" id="systolic" placeholder="120">
        </div>
        <div class="input-group">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï (Diastolic):</label>
          <input type="number" id="diastolic" placeholder="80">
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à (bpm):</label>
          <input type="number" id="heartRateInput" placeholder="72">
        </div>
        <div class="input-group">
          <label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C):</label>
          <input type="number" id="temperatureInput" placeholder="36.5" step="0.1">
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label>‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (%):</label>
          <input type="number" id="oxygenInput" placeholder="98">
        </div>
        <div class="input-group">
          <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à (per min):</label>
          <input type="number" id="respiratoryRate" placeholder="16">
        </div>
      </div>
      <button class="btn btn-success" onclick="saveVitalSigns()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-secondary" onclick="closeModal('vitalModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <!-- Medication Schedule Modal -->
  <div class="modal" id="medModal">
    <div class="modal-content">
      <div class="modal-title">üíä ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤</div>
      <div class="input-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤:</label>
        <input type="text" id="medName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Paracetamol">
      </div>
      <div class="input-row">
        <div class="input-group">
          <label>‡∏Ç‡∏ô‡∏≤‡∏î:</label>
          <input type="text" id="medDose" placeholder="500mg">
        </div>
        <div class="input-group">
          <label>‡πÄ‡∏ß‡∏•‡∏≤:</label>
          <input type="time" id="medTime">
        </div>
      </div>
      <div class="input-group">
        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</label>
        <textarea id="medNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
      </div>
      <button class="btn btn-success" onclick="addMedication()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤</button>
      <button class="btn btn-secondary" onclick="closeModal('medModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <!-- Calculator Modal -->
  <div class="modal" id="calcModal">
    <div class="modal-content">
      <div class="modal-title">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠</div>
      <div class="input-group">
        <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (mL):</label>
        <input type="number" id="calcVolume" placeholder="1000">
      </div>
      <div class="input-group">
        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ):</label>
        <input type="number" id="calcRate" placeholder="30">
      </div>
      <div class="input-group">
        <label>Drop Factor:</label>
        <select id="dropFactor">
          <option value="20">20 ‡∏´‡∏¢‡∏î/cc</option>
          <option value="15">15 ‡∏´‡∏¢‡∏î/cc</option>
          <option value="60">60 ‡∏´‡∏¢‡∏î/cc (Micro)</option>
        </select>
      </div>
      <div id="calcResult" class="calculation-result" style="display: none;"></div>
      <button class="btn btn-primary" onclick="calculateFlow()">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
      <button class="btn btn-secondary" onclick="closeModal('calcModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <script>
    let bedId = 1;
    let currentUser = null;
    let chartInstance = null;
    let alerts = [];

    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
    });

    function initializePage() {
      currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      if (!currentUser) {
        window.location.href = 'index.html';
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      bedId = urlParams.get('bed') || 1;
      document.getElementById('bedTitle').textContent = `üè• ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà ${bedId}`;

      loadPatientData();
      loadNotes();
      loadVitalSigns();
      loadMedications();
      initChart();
      updateStatus();
      checkAlerts();

      setInterval(updateStatus, 10000);
      setInterval(checkAlerts, 30000);
    }

    function loadPatientData() {
      const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${bedId}`) || 'null');

      if (patientData) {
        document.getElementById('patientInfo').style.display = 'block';
        document.getElementById('patientId').textContent = patientData.patient_id;
        document.getElementById('medication').textContent = patientData.medication;
        document.getElementById('volume').textContent = patientData.volume;
        document.getElementById('rate').textContent = patientData.rate + ' ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ';
        document.getElementById('orderedFlow').textContent = patientData.rate;

        // Auto-populate IV calculator
        populateIVCalculator(patientData);
      } else {
        document.getElementById('patientInfo').style.display = 'none';
        document.getElementById('orderedFlow').textContent = '0';
        clearIVCalculator();
      }
    }

    function populateIVCalculator(patientData) {
      // Extract volume number from string like "500mL"
      const volumeMatch = patientData.volume.match(/\d+/);
      const volume = volumeMatch ? parseInt(volumeMatch[0]) : 0;

      // Populate inputs
      document.getElementById('autoVolume').value = volume;
      document.getElementById('autoRate').value = patientData.rate;
      document.getElementById('medicationType').textContent = patientData.medication;

      // Calculate immediately
      calculateAutoIV();
    }

    function clearIVCalculator() {
      document.getElementById('autoVolume').value = '';
      document.getElementById('autoRate').value = '';
      document.getElementById('medicationType').textContent = '-';
      
      // Reset results
      document.getElementById('flowRate').textContent = '0 cc/hr';
      document.getElementById('finishTime').textContent = '0 ‡∏ä‡∏°. 0 ‡∏ô‡∏≤‡∏ó‡∏µ';
      document.getElementById('dropPerSec').textContent = '0 ‡∏î‡∏£‡∏≠‡∏õ/‡∏ß‡∏¥';
      document.getElementById('estimatedFinish').textContent = '-';
      
      // Stop tracking
      stopTimeTracking();
    }

    function loadVitalSigns() {
      const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${bedId}`) || 'null');

      if (vitals) {
        document.getElementById('vitalSigns').style.display = 'block';
        document.getElementById('bloodPressure').textContent = `${vitals.systolic}/${vitals.diastolic}`;
        document.getElementById('heartRate').textContent = vitals.heartRate;
        document.getElementById('temperature').textContent = vitals.temperature + '¬∞C';
        document.getElementById('oxygenSat').textContent = (vitals.oxygen || 98) + '%';

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
        const vitalSection = document.getElementById('vitalSigns');
        const existingTime = vitalSection.querySelector('.vital-time');
        if (existingTime) existingTime.remove();

        const timeDiv = document.createElement('div');
        timeDiv.className = 'vital-time';
        timeDiv.style.cssText = 'font-size: 11px; color: #64748b; text-align: right; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;';
        timeDiv.innerHTML = `
          <span>‡∏ß‡∏±‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${vitals.time || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
          <button onclick="deleteVitals()" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">‡∏•‡∏ö</button>
        `;
        vitalSection.appendChild(timeDiv);
      } else {
        document.getElementById('vitalSigns').style.display = 'none';
      }
    }

    function deleteVitals() {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Vital Signs?')) return;

      localStorage.removeItem(`vitals_bed_${bedId}`);
      loadVitalSigns();
      checkAlerts();
      alert('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Vital Signs ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

    function loadMedications() {
      const medications = JSON.parse(localStorage.getItem(`medications_bed_${bedId}`) || '[]');
      const medList = document.getElementById('medList');

      if (medications.length > 0) {
        document.getElementById('medicationSchedule').style.display = 'block';
        medList.innerHTML = medications.map((med, index) => `
          <div class="med-item">
            <div>
              <div class="med-name">${med.name} - ${med.dose}</div>
              <div style="font-size: 11px; color: #64748b;">${med.note || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div class="med-time">${med.time}</div>
              <button onclick="deleteMedication(${index})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">‡∏•‡∏ö</button>
            </div>
          </div>
        `).join('');
      } else {
        document.getElementById('medicationSchedule').style.display = 'none';
      }
    }

    function deleteMedication(index) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏µ‡πâ?')) return;

      const medications = JSON.parse(localStorage.getItem(`medications_bed_${bedId}`) || '[]');
      medications.splice(index, 1);
      localStorage.setItem(`medications_bed_${bedId}`, JSON.stringify(medications));

      loadMedications();
      alert('‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

    function checkAlerts() {
      alerts = [];

      const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${bedId}`) || 'null');
      const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${bedId}`) || 'null');

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á snooze ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const isSnoozeActive = checkIfBedIsSnooze(bedId);
      
      if (patientData && !isSnoozeActive) {
        const currentFlow = parseInt(document.getElementById('currentFlow').textContent);
        const orderedFlow = patientData.rate;

        if (Math.abs(currentFlow - orderedFlow) > 5) {
          alerts.push({
            icon: '‚ö†Ô∏è',
            text: `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á (${currentFlow} vs ${orderedFlow})`,
            type: 'flow_variance',
            severity: Math.abs(currentFlow - orderedFlow) > 10 ? 'critical' : 'warning',
            bedId: bedId,
            canSnooze: true
          });
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î
        const finishTimeData = JSON.parse(localStorage.getItem(`iv_finish_time_bed_${bedId}`) || 'null');
        if (finishTimeData) {
          const finishTime = new Date(finishTimeData.finishTime);
          const timeLeftMs = finishTime - new Date();
          const timeLeftMinutes = timeLeftMs / (1000 * 60);
          
          if (timeLeftMs > 0 && timeLeftMinutes <= 30) {
            alerts.push({
              icon: 'üíß',
              text: `‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡∏à‡∏∞‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${Math.round(timeLeftMinutes)} ‡∏ô‡∏≤‡∏ó‡∏µ`,
              type: 'saline_warning',
              severity: timeLeftMinutes <= 10 ? 'critical' : 'warning',
              bedId: bedId,
              canSnooze: true,
              timeLeft: timeLeftMinutes
            });
          }
        }
      }

      if (vitals && !isSnoozeActive) {
        if (vitals.systolic > 140 || vitals.diastolic > 90) {
          alerts.push({
            icon: 'üî¥',
            text: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á',
            type: 'blood_pressure',
            severity: (vitals.systolic > 160 || vitals.diastolic > 100) ? 'critical' : 'warning',
            bedId: bedId,
            canSnooze: true
          });
        }

        if (vitals.heartRate > 100 || vitals.heartRate < 60) {
          alerts.push({
            icon: 'üíì',
            text: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥',
            type: 'heart_rate',
            severity: (vitals.heartRate > 120 || vitals.heartRate < 50) ? 'critical' : 'warning',
            bedId: bedId,
            canSnooze: true
          });
        }

        if (vitals.temperature > 37.5) {
          alerts.push({
            icon: 'üå°Ô∏è',
            text: '‡∏°‡∏µ‡πÑ‡∏Ç‡πâ',
            type: 'temperature',
            severity: vitals.temperature > 38.5 ? 'critical' : 'warning',
            bedId: bedId,
            canSnooze: true
          });
        }

        if (vitals.oxygen < 95) {
          alerts.push({
            icon: 'ü´Å',
            text: '‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡πà‡∏≥',
            type: 'oxygen',
            severity: vitals.oxygen < 90 ? 'critical' : 'warning',
            bedId: bedId,
            canSnooze: true
          });
        }
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ snooze ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (isSnoozeActive) {
        const snoozeInfo = getSnoozeInfo(bedId);
        if (snoozeInfo) {
          alerts.push({
            icon: 'üò¥',
            text: `‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å Snooze ‡∏≠‡∏µ‡∏Å ${snoozeInfo.timeLeft}`,
            type: 'snooze_status',
            severity: 'info',
            bedId: bedId,
            canSnooze: false,
            isSnoozeStatus: true
          });
        }
      }

      updateAlertsDisplay();
    }

    function checkIfBedIsSnooze(bedId) {
      const allSnoozes = JSON.parse(localStorage.getItem('global_snooze_data') || '[]');
      const now = new Date();
      
      return allSnoozes.some(snooze => 
        snooze.bedId == bedId && 
        snooze.status === 'active' && 
        new Date(snooze.snoozeUntil) > now
      );
    }

    function getSnoozeInfo(bedId) {
      const allSnoozes = JSON.parse(localStorage.getItem('global_snooze_data') || '[]');
      const now = new Date();
      
      const activeSnooze = allSnoozes.find(snooze => 
        snooze.bedId == bedId && 
        snooze.status === 'active' && 
        new Date(snooze.snoozeUntil) > now
      );
      
      if (activeSnooze) {
        const timeLeft = new Date(activeSnooze.snoozeUntil) - now;
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.round((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        return {
          timeLeft: hours > 0 ? `${hours}‡∏ä‡∏°.${minutes}‡∏ô‡∏≤‡∏ó‡∏µ` : `${minutes}‡∏ô‡∏≤‡∏ó‡∏µ`,
          snoozeData: activeSnooze
        };
      }
      
      return null;
    }

    function snoozeAlertFromChart(alertType, minutes) {
      const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${bedId}`) || 'null');
      
      const snoozeData = {
        id: `chart_${alertType}_${bedId}_${Date.now()}`,
        alertId: `chart_alert_${Date.now()}`,
        bedId: bedId,
        alertType: alertType,
        alertMessage: `‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Chart - ${alertType}`,
        snoozeMinutes: minutes,
        snoozeUntil: new Date(Date.now() + minutes * 60 * 1000).toISOString(),
        snoozeAt: new Date().toISOString(),
        snoozeBy: currentUser?.fullname || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö',
        originalAlert: { 
          type: alertType, 
          bedId: bedId, 
          message: `‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Chart`,
          patientData: patientData
        },
        status: 'active',
        wakeUpNotified: false,
        location: 'chart'
      };
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
      const allSnoozes = JSON.parse(localStorage.getItem('global_snooze_data') || '[]');
      allSnoozes.push(snoozeData);
      localStorage.setItem('global_snooze_data', JSON.stringify(allSnoozes));
      
      // ‡∏ï‡∏±‡πâ‡∏á timer
      setTimeout(() => {
        const updatedSnoozes = JSON.parse(localStorage.getItem('global_snooze_data') || '[]');
        const finalSnoozes = updatedSnoozes.map(snooze => {
          if (snooze.id === snoozeData.id) {
            return { ...snooze, status: 'expired', wakeUpNotified: true };
          }
          return snooze;
        });
        localStorage.setItem('global_snooze_data', JSON.stringify(finalSnoozes));
        
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ snooze
        alert(`‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ Snooze ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedId} - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
        checkAlerts(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      }, minutes * 60 * 1000);
      
      alert(`üò¥ Snooze ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedId} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`);
      checkAlerts(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    }

    function updateAlertsDisplay() {
      const alertsSection = document.getElementById('alertsSection');
      const alertsList = document.getElementById('alertsList');

      if (alerts.length > 0) {
        alertsSection.classList.add('active');
        alertsList.innerHTML = alerts.map((alert, index) => `
          <div class="alert-item ${alert.severity || 'info'}" style="
            border-left: 4px solid ${alert.severity === 'critical' ? '#ef4444' : alert.severity === 'warning' ? '#f59e0b' : '#06b6d4'};
            margin-bottom: 10px;
            padding: 12px;
            background: ${alert.isSnoozeStatus ? 'linear-gradient(135deg, #f3f4f6, #e5e7eb)' : 'white'};
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
              <div class="alert-icon" style="font-size: 20px; min-width: 24px;">${alert.icon}</div>
              <div class="alert-text" style="flex: 1; font-size: 14px; color: #374151;">${alert.text}</div>
            </div>
            
            ${alert.canSnooze && !alert.isSnoozeStatus ? `
              <div style="display: flex; gap: 5px; align-items: center;">
                <button onclick="snoozeAlertFromChart('${alert.type}', 10)" style="
                  background: #8b5cf6;
                  color: white;
                  border: none;
                  padding: 6px 10px;
                  border-radius: 6px;
                  font-size: 11px;
                  cursor: pointer;
                  white-space: nowrap;
                ">üò¥ 10‡∏ô‡∏≤‡∏ó‡∏µ</button>
                <button onclick="snoozeAlertFromChart('${alert.type}', 30)" style="
                  background: #8b5cf6;
                  color: white;
                  border: none;
                  padding: 6px 10px;
                  border-radius: 6px;
                  font-size: 11px;
                  cursor: pointer;
                  white-space: nowrap;
                ">üò¥ 30‡∏ô‡∏≤‡∏ó‡∏µ</button>
              </div>
            ` : ''}
          </div>
        `).join('');
      } else {
        alertsSection.classList.remove('active');
      }
    }

    function updateStatus() {
      const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${bedId}`) || 'null');

      // ‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
      let currentFlow;
      if (patientData && patientData.rate) {
        const baseRate = patientData.rate;
        const variation = Math.floor(Math.random() * 6) - 3; // +/- 3
        currentFlow = Math.max(0, baseRate + variation);
      } else {
        currentFlow = Math.floor(Math.random() * 10) + 15;
      }

      document.getElementById('currentFlow').textContent = currentFlow;

      if (chartInstance) {
        const now = new Date();
        const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                         now.getMinutes().toString().padStart(2, '0');

        chartInstance.data.labels.push(timeLabel);
        chartInstance.data.datasets[0].data.push(currentFlow);

        if (chartInstance.data.labels.length > 20) {
          chartInstance.data.labels.shift();
          chartInstance.data.datasets[0].data.shift();
        }

        chartInstance.update('none');
      }

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•
      const flowHistory = JSON.parse(localStorage.getItem(`flow_history_bed_${bedId}`) || '[]');
      flowHistory.push({
        flow: currentFlow,
        time: new Date().toISOString(),
        timestamp: Date.now()
      });

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡πà 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
      const recentHistory = flowHistory.filter(record => record.timestamp > oneDayAgo);
      localStorage.setItem(`flow_history_bed_${bedId}`, JSON.stringify(recentHistory));
    }

    function initChart() {
      const ctx = document.getElementById('flowChart').getContext('2d');

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      const flowHistory = JSON.parse(localStorage.getItem(`flow_history_bed_${bedId}`) || '[]');
      const recentHistory = flowHistory.slice(-10); // ‡πÅ‡∏™‡∏î‡∏á 10 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

      const labels = recentHistory.map(record => {
        const date = new Date(record.time);
        return date.getHours().toString().padStart(2, '0') + ':' + 
               date.getMinutes().toString().padStart(2, '0');
      });

      const data = recentHistory.map(record => record.flow);

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏• (‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ)',
            data: data,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14, 165, 233, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#0ea5e9',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 60,
              ticks: {
                stepSize: 10,
                color: '#64748b'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#64748b'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#1e293b',
                font: {
                  size: 14,
                  weight: 600
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#0ea5e9',
              borderWidth: 1
            }
          }
        }
      });
    }

    function showPatientModal() {
      const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${bedId}`) || 'null');
      if (patientData) {
        document.getElementById('modalPatientId').value = patientData.patient_id;
        document.getElementById('modalMedication').value = patientData.medication;
        document.getElementById('modalVolume').value = parseInt(patientData.volume);
        document.getElementById('modalRate').value = patientData.rate;
      }
      document.getElementById('patientModal').style.display = 'flex';
    }

    function showIOModal() {
      document.getElementById('ioModal').style.display = 'flex';
    }

    function showVitalModal() {
      const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${bedId}`) || 'null');
      if (vitals) {
        document.getElementById('systolic').value = vitals.systolic;
        document.getElementById('diastolic').value = vitals.diastolic;
        document.getElementById('heartRateInput').value = vitals.heartRate;
        document.getElementById('temperatureInput').value = vitals.temperature;
        document.getElementById('oxygenInput').value = vitals.oxygen;
        document.getElementById('respiratoryRate').value = vitals.respiratory;
      }
      document.getElementById('vitalModal').style.display = 'flex';
    }

    function showMedModal() {
      document.getElementById('medModal').style.display = 'flex';
    }

    function showCalcModal() {
      document.getElementById('calcModal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      clearModalInputs(modalId);
    }

    function clearModalInputs(modalId) {
      const modal = document.getElementById(modalId);
      modal.querySelectorAll('input[type="text"], input[type="number"], input[type="time"], textarea').forEach(input => {
        input.value = '';
      });
      modal.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
      });
    }

    function savePatientData() {
      const patientId = document.getElementById('modalPatientId').value.trim();
      const medication = document.getElementById('modalMedication').value;
      const volume = document.getElementById('modalVolume').value;
      const rate = document.getElementById('modalRate').value;

      if (!patientId || !volume || !rate) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      const patientData = {
        patient_id: patientId,
        medication: medication,
        volume: volume + 'mL',
        rate: parseInt(rate),
        timestamp: new Date().toISOString()
      };

      localStorage.setItem(`ir_data_bed_${bedId}`, JSON.stringify(patientData));

      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      notes.unshift({
        content: `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${patientId} | ${medication} ${volume}mL @ ${rate} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ`,
        time: new Date().toLocaleString('th-TH'),
        author: currentUser.fullname,
        type: 'medication'
      });
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));

      closeModal('patientModal');
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      loadPatientData(); // This will auto-populate and calculate IV
      loadNotes();
    }

    function saveVitalSigns() {
      const systolic = document.getElementById('systolic').value;
      const diastolic = document.getElementById('diastolic').value;
      const heartRate = document.getElementById('heartRateInput').value;
      const temperature = document.getElementById('temperatureInput').value;
      const oxygen = document.getElementById('oxygenInput').value;
      const respiratory = document.getElementById('respiratoryRate').value;

      if (!systolic || !diastolic || !heartRate || !temperature) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      const vitals = {
        systolic: parseInt(systolic),
        diastolic: parseInt(diastolic),
        heartRate: parseInt(heartRate),
        temperature: parseFloat(temperature),
        oxygen: parseInt(oxygen),
        respiratory: parseInt(respiratory),
        timestamp: new Date().toISOString(),
        time: new Date().toLocaleString('th-TH'),
        author: currentUser.fullname
      };

      localStorage.setItem(`vitals_bed_${bedId}`, JSON.stringify(vitals));

      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      notes.unshift({
        content: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vital Signs: BP ${systolic}/${diastolic}, HR ${heartRate}, Temp ${temperature}¬∞C, O2 ${oxygen}%`,
        time: new Date().toLocaleString('th-TH'),
        author: currentUser.fullname,
        type: 'vital_signs'
      });
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));

      closeModal('vitalModal');
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vital Signs ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      loadVitalSigns();
      loadNotes();
      checkAlerts();
    }

    function addMedication() {
      const name = document.getElementById('medName').value.trim();
      const dose = document.getElementById('medDose').value.trim();
      const time = document.getElementById('medTime').value;
      const note = document.getElementById('medNote').value.trim();

      if (!name || !dose || !time) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      const medications = JSON.parse(localStorage.getItem(`medications_bed_${bedId}`) || '[]');
      medications.push({
        name: name,
        dose: dose,
        time: time,
        note: note,
        timestamp: new Date().toISOString(),
        author: currentUser.fullname
      });

      localStorage.setItem(`medications_bed_${bedId}`, JSON.stringify(medications));

      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      notes.unshift({
        content: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤: ${name} ${dose} ‡πÄ‡∏ß‡∏•‡∏≤ ${time}`,
        time: new Date().toLocaleString('th-TH'),
        author: currentUser.fullname,
        type: 'medication_schedule'
      });
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));

      closeModal('medModal');
      alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      loadMedications();
      loadNotes();
    }

    function calculateIO() {
      const inputWater = parseInt(document.getElementById('inputWater').value) || 0;
      const inputFood = parseInt(document.getElementById('inputFood').value) || 0;
      const inputIV = parseInt(document.getElementById('inputIV').value) || 0;
      const inputBlood = parseInt(document.getElementById('inputBlood').value) || 0;

      const outputUrine = parseInt(document.getElementById('outputUrine').value) || 0;
      const outputVomit = parseInt(document.getElementById('outputVomit').value) || 0;
      const outputDrain = parseInt(document.getElementById('outputDrain').value) || 0;
      const outputStool = parseInt(document.getElementById('outputStool').value) || 0;

      const totalIn = inputWater + inputFood + inputIV + inputBlood;
      const totalOut = outputUrine + outputVomit + outputDrain + outputStool;
      const balance = totalIn - totalOut;

      const result = document.getElementById('ioResult');
      result.innerHTML = `
        <div class="result-item">
          <span>INPUT ‡∏£‡∏ß‡∏°:</span>
          <span class="result-value">${totalIn} mL</span>
        </div>
        <div class="result-item">
          <span>OUTPUT ‡∏£‡∏ß‡∏°:</span>
          <span class="result-value">${totalOut} mL</span>
        </div>
        <div class="result-item">
          <span>BALANCE:</span>
          <span class="result-value" style="color: ${balance >= 0 ? '#22c55e' : '#ef4444'}">
            ${balance > 0 ? '+' : ''}${balance} mL
          </span>
        </div>
      `;
      result.style.display = 'block';
    }

    function saveIOData() {
      calculateIO();

      const inputWater = parseInt(document.getElementById('inputWater').value) || 0;
      const inputFood = parseInt(document.getElementById('inputFood').value) || 0;
      const inputIV = parseInt(document.getElementById('inputIV').value) || 0;
      const inputBlood = parseInt(document.getElementById('inputBlood').value) || 0;

      const outputUrine = parseInt(document.getElementById('outputUrine').value) || 0;
      const outputVomit = parseInt(document.getElementById('outputVomit').value) || 0;
      const outputDrain = parseInt(document.getElementById('outputDrain').value) || 0;
      const outputStool = parseInt(document.getElementById('outputStool').value) || 0;

      const totalIn = inputWater + inputFood + inputIV + inputBlood;
      const totalOut = outputUrine + outputVomit + outputDrain + outputStool;
      const balance = totalIn - totalOut;

      const ioRecord = {
        bedId: bedId,
        timestamp: new Date().toISOString(),
        time: new Date().toLocaleString('th-TH'),
        input: { water: inputWater, food: inputFood, iv: inputIV, blood: inputBlood },
        output: { urine: outputUrine, vomit: outputVomit, drain: outputDrain, stool: outputStool },
        totalIn: totalIn,
        totalOut: totalOut,
        balance: balance,
        author: currentUser.fullname
      };

      const ioRecords = JSON.parse(localStorage.getItem(`io_records_bed_${bedId}`) || '[]');
      ioRecords.unshift(ioRecord);
      localStorage.setItem(`io_records_bed_${bedId}`, JSON.stringify(ioRecords));

      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      notes.unshift({
        content: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O: Input ${totalIn}mL, Output ${totalOut}mL, Balance ${balance > 0 ? '+' : ''}${balance}mL`,
        time: new Date().toLocaleString('th-TH'),
        author: currentUser.fullname,
        type: 'fluid_balance'
      });
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));

      closeModal('ioModal');
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      loadNotes();
    }

    function calculateFlow() {
      const volume = parseFloat(document.getElementById('calcVolume').value) || 0;
      const rate = parseFloat(document.getElementById('calcRate').value) || 0;
      const dropFactor = parseFloat(document.getElementById('dropFactor').value) || 20;

      if (!volume || !rate) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      const ccPerHr = (rate * 60) / dropFactor;
      const timeHours = volume / ccPerHr;
      const hours = Math.floor(timeHours);
      const minutes = Math.round((timeHours - hours) * 60);

      const result = document.getElementById('calcResult');
      result.innerHTML = `
        <div class="result-item">
          <span>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•:</span>
          <span class="result-value">${ccPerHr.toFixed(1)} cc/hr</span>
        </div>
        <div class="result-item">
          <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏´‡∏°‡∏î:</span>
          <span class="result-value">${hours} ‡∏ä‡∏°. ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
        </div>
        <div class="result-item">
          <span>‡∏´‡∏¢‡∏î‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ:</span>
          <span class="result-value">${(rate/60).toFixed(1)} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ß‡∏¥</span>
        </div>
      `;
      result.style.display = 'block';
    }

    function addNote() {
      const content = document.getElementById('noteInput').value.trim();
      if (!content) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }

      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      notes.unshift({
        content: content,
        time: new Date().toLocaleString('th-TH'),
        author: currentUser.fullname,
        type: 'general'
      });
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));

      document.getElementById('noteInput').value = '';
      loadNotes();
    }

    function loadNotes() {
      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      const notesList = document.getElementById('notesList');

      if (notes.length === 0) {
        notesList.innerHTML = '<div class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>';
        return;
      }

      notesList.innerHTML = notes.slice(0, 10).map(note => `
        <div class="note-item">
          <div class="note-header">
            <div class="note-author">üë§ ${note.author}</div>
            <div class="note-time">${note.time}</div>
          </div>
          <div class="note-content">${note.content}</div>
        </div>
      `).join('');
    }

    function resetBedData() {
      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà ${bedId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

      localStorage.removeItem(`ir_data_bed_${bedId}`);
      localStorage.removeItem(`nurseNotes_${bedId}`);
      localStorage.removeItem(`io_records_bed_${bedId}`);
      localStorage.removeItem(`vitals_bed_${bedId}`);
      localStorage.removeItem(`medications_bed_${bedId}`);

      alert('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      location.reload();
    }

    function logout() {
      if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
        sessionStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }

    // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    document.getElementById('noteInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && e.ctrlKey) {
        addNote();
      }
    });

    // Enhanced Auto IV Calculator Functions with complete data linking
    function calculateAutoIV() {
      const volume = parseFloat(document.getElementById('autoVolume').value) || 0;
      const rate = parseFloat(document.getElementById('autoRate').value) || 0;
      const dropFactor = parseFloat(document.getElementById('autoDropFactor').value) || 20;

      if (!volume || !rate) {
        resetIVCalculatorDisplay();
        return;
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏à‡∏≤‡∏Å localStorage
      const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${bedId}`) || 'null');
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
      const ccPerHr = (rate * 60) / dropFactor;
      const timeHours = volume / ccPerHr;
      const hours = Math.floor(timeHours);
      const minutes = Math.round((timeHours - hours) * 60);
      const dropPerSec = rate / 60;
      const mlPerMin = ccPerHr / 60;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏´‡∏°‡∏î
      const startTime = new Date();
      const finishTime = new Date(startTime.getTime() + (timeHours * 60 * 60 * 1000));
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤
      const estimatedFinish = finishTime.toLocaleString('th-TH', {
        weekday: 'short',
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      updateIVDisplayResults(ccPerHr, hours, minutes, dropPerSec, estimatedFinish, mlPerMin);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
      const completeCalcData = createCompleteCalculationData(
        volume, rate, dropFactor, ccPerHr, timeHours, 
        hours, minutes, dropPerSec, mlPerMin, startTime, 
        finishTime, estimatedFinish, patientData, currentUser
      );

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
      saveCalculationDataToStorage(completeCalcData);

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
      startAdvancedRealTimeTracking(completeCalcData);

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
      addCalculationNote(completeCalcData);

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      updateUsageStatistics(completeCalcData);
    }

    function resetIVCalculatorDisplay() {
      document.getElementById('flowRate').textContent = '0 cc/hr';
      document.getElementById('finishTime').textContent = '0 ‡∏ä‡∏°. 0 ‡∏ô‡∏≤‡∏ó‡∏µ';
      document.getElementById('dropPerSec').textContent = '0 ‡∏î‡∏£‡∏≠‡∏õ/‡∏ß‡∏¥';
      document.getElementById('estimatedFinish').textContent = '-';
      stopAdvancedTimeTracking();
      clearCalculationFromStorage();
    }

    function updateIVDisplayResults(ccPerHr, hours, minutes, dropPerSec, estimatedFinish, mlPerMin) {
      document.getElementById('flowRate').textContent = `${ccPerHr.toFixed(1)} cc/hr`;
      document.getElementById('finishTime').textContent = `${hours} ‡∏ä‡∏°. ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
      document.getElementById('dropPerSec').textContent = `${dropPerSec.toFixed(1)} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ß‡∏¥`;
      document.getElementById('estimatedFinish').textContent = estimatedFinish;

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏°
      const flowRateElement = document.getElementById('flowRate');
      flowRateElement.title = `${mlPerMin.toFixed(2)} mL/‡∏ô‡∏≤‡∏ó‡∏µ | ${(ccPerHr/24).toFixed(1)} cc/‡∏ä‡∏°./‡∏ß‡∏±‡∏ô`;
    }

    function createCompleteCalculationData(volume, rate, dropFactor, ccPerHr, timeHours, hours, minutes, dropPerSec, mlPerMin, startTime, finishTime, estimatedFinish, patientData, currentUser) {
      return {
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        volume: volume,
        rate: rate,
        dropFactor: dropFactor,
        
        // ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        ccPerHr: parseFloat(ccPerHr.toFixed(1)),
        timeHours: parseFloat(timeHours.toFixed(2)),
        hours: hours,
        minutes: minutes,
        dropPerSec: parseFloat(dropPerSec.toFixed(1)),
        mlPerMin: parseFloat(mlPerMin.toFixed(2)),
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤
        startTime: startTime.toISOString(),
        finishTime: finishTime.toISOString(),
        estimatedFinish: estimatedFinish,
        calculatedAt: new Date().toISOString(),
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        bedId: bedId,
        patientId: patientData?.patient_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        medication: patientData?.medication || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        calculatedBy: currentUser?.fullname || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        volumePerHour: parseFloat(ccPerHr.toFixed(1)),
        volumePerDay: parseFloat((ccPerHr * 24).toFixed(1)),
        totalDrops: Math.round(rate * timeHours * 60),
        
        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
        isTracking: true,
        trackingStarted: new Date().toISOString(),
        
        // ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        alertAt30Min: new Date(finishTime.getTime() - 30 * 60 * 1000).toISOString(),
        alertAt10Min: new Date(finishTime.getTime() - 10 * 60 * 1000).toISOString(),
        alertAt5Min: new Date(finishTime.getTime() - 5 * 60 * 1000).toISOString()
      };
    }

    function saveCalculationDataToStorage(calcData) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏Å
      localStorage.setItem(`iv_calculation_bed_${bedId}`, JSON.stringify(calcData));
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dashboard
      localStorage.setItem(`iv_finish_time_bed_${bedId}`, JSON.stringify({
        finishTime: calcData.finishTime,
        volume: calcData.volume,
        rate: calcData.rate,
        bedId: bedId,
        patientId: calcData.patientId,
        medication: calcData.medication
      }));
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
      const calcHistory = JSON.parse(localStorage.getItem(`iv_calc_history_bed_${bedId}`) || '[]');
      calcHistory.unshift(calcData);
      
      // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      if (calcHistory.length > 20) {
        calcHistory.splice(20);
      }
      
      localStorage.setItem(`iv_calc_history_bed_${bedId}`, JSON.stringify(calcHistory));
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°
      updateGlobalIVStatistics(calcData);
    }

    function clearCalculationFromStorage() {
      localStorage.removeItem(`iv_calculation_bed_${bedId}`);
      localStorage.removeItem(`iv_finish_time_bed_${bedId}`);
      localStorage.removeItem(`iv_tracking_bed_${bedId}`);
    }

    function addCalculationNote(calcData) {
      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      const noteContent = `üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠: ${calcData.volume}mL @ ${calcData.rate} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ${calcData.ccPerHr} cc/hr | ‡∏´‡∏°‡∏î‡πÉ‡∏ô ${calcData.hours}‡∏ä‡∏°.${calcData.minutes}‡∏ô‡∏≤‡∏ó‡∏µ | ‡πÄ‡∏ß‡∏•‡∏≤ ${calcData.estimatedFinish}`;
      
      notes.unshift({
        id: Date.now().toString(),
        content: noteContent,
        type: 'iv_calculation',
        bedId: bedId,
        patientId: calcData.patientId,
        time: new Date().toLocaleString('th-TH'),
        timestamp: new Date().toISOString(),
        author: calcData.calculatedBy,
        calculationData: calcData
      });
      
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));
    }

    function updateUsageStatistics(calcData) {
      const stats = JSON.parse(localStorage.getItem('system_usage_stats') || '{}');
      
      if (!stats.ivCalculations) stats.ivCalculations = [];
      if (!stats.dailyStats) stats.dailyStats = {};
      
      const today = new Date().toDateString();
      if (!stats.dailyStats[today]) {
        stats.dailyStats[today] = { calculations: 0, totalVolume: 0, avgRate: 0 };
      }
      
      stats.ivCalculations.push({
        bedId: calcData.bedId,
        timestamp: calcData.calculatedAt,
        volume: calcData.volume,
        rate: calcData.rate,
        ccPerHr: calcData.ccPerHr
      });
      
      stats.dailyStats[today].calculations++;
      stats.dailyStats[today].totalVolume += calcData.volume;
      
      localStorage.setItem('system_usage_stats', JSON.stringify(stats));
    }

    function updateGlobalIVStatistics(calcData) {
      const globalStats = JSON.parse(localStorage.getItem('global_iv_statistics') || '{}');
      
      if (!globalStats.totalCalculations) globalStats.totalCalculations = 0;
      if (!globalStats.totalVolume) globalStats.totalVolume = 0;
      if (!globalStats.averageRate) globalStats.averageRate = 0;
      if (!globalStats.bedStatistics) globalStats.bedStatistics = {};
      
      globalStats.totalCalculations++;
      globalStats.totalVolume += calcData.volume;
      globalStats.averageRate = (globalStats.averageRate * (globalStats.totalCalculations - 1) + calcData.rate) / globalStats.totalCalculations;
      
      if (!globalStats.bedStatistics[bedId]) {
        globalStats.bedStatistics[bedId] = { calculations: 0, totalVolume: 0, lastCalculation: null };
      }
      
      globalStats.bedStatistics[bedId].calculations++;
      globalStats.bedStatistics[bedId].totalVolume += calcData.volume;
      globalStats.bedStatistics[bedId].lastCalculation = calcData.calculatedAt;
      
      localStorage.setItem('global_iv_statistics', JSON.stringify(globalStats));
    }

    let advancedIVTracker = null;
    let trackingIntervals = [];
    let alertTimeouts = [];
    let syncInterval = null;

    class AdvancedIVTracker {
      constructor(calcData) {
        this.calcData = calcData;
        this.startTime = new Date(calcData.startTime);
        this.endTime = new Date(calcData.finishTime);
        this.originalDuration = this.endTime.getTime() - this.startTime.getTime();
        this.isActive = true;
        this.lastNotificationTime = null;
        this.alertsSent = {
          thirtyMin: false,
          tenMin: false,
          fiveMin: false,
          finished: false
        };
        this.quickActionEnabled = true;
        this.autoSyncEnabled = true;
      }

      start() {
        this.setupMainTracker();
        this.setupAlertSystem();
        this.setupAutoSync();
        this.saveTrackingState();
        this.updateStatusIndicator('active');
        this.showStartNotification();
      }

      setupMainTracker() {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
        const mainInterval = setInterval(() => {
          if (!this.isActive) {
            clearInterval(mainInterval);
            return;
          }
          this.updateDisplay();
          this.checkAlerts();
          this.saveCurrentState();
        }, 5000);
        
        trackingIntervals.push(mainInterval);
      }

      setupAutoSync() {
        // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        syncInterval = setInterval(() => {
          if (!this.isActive) return;
          this.syncPatientData();
        }, 30000);
      }

      showStartNotification() {
        const notification = document.createElement('div');
        notification.innerHTML = `
          <div style="
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white; padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
            animation: slideIn 0.5s ease;
          ">
            <div style="font-weight: 600; margin-bottom: 5px;">‚è∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß</div>
            <div style="font-size: 12px; opacity: 0.9;">
              ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedId} - ${this.calcData.medication} ${this.calcData.volume}mL
            </div>
          </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.5s ease';
          setTimeout(() => notification.remove(), 500);
        }, 3000);
      }

      syncPatientData() {
        const currentPatient = JSON.parse(localStorage.getItem(`ir_data_bed_${bedId}`) || 'null');
        if (currentPatient) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (currentPatient.patient_id !== this.calcData.patientId || 
              currentPatient.medication !== this.calcData.medication) {
            console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°');
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô calcData
            this.calcData.patientId = currentPatient.patient_id;
            this.calcData.medication = currentPatient.medication;
            this.saveTrackingState();
          }
        }
      }

      setupAlertSystem() {
        const now = new Date().getTime();
        
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        if (this.calcData.alertAt30Min) {
          const thirtyMinAlert = new Date(this.calcData.alertAt30Min).getTime();
          if (thirtyMinAlert > now) {
            const timeout = setTimeout(() => {
              this.sendAlert('30‡∏ô‡∏≤‡∏ó‡∏µ', 'warning');
              this.alertsSent.thirtyMin = true;
            }, thirtyMinAlert - now);
            alertTimeouts.push(timeout);
          }
        }

        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ
        if (this.calcData.alertAt10Min) {
          const tenMinAlert = new Date(this.calcData.alertAt10Min).getTime();
          if (tenMinAlert > now) {
            const timeout = setTimeout(() => {
              this.sendAlert('10‡∏ô‡∏≤‡∏ó‡∏µ', 'critical');
              this.alertsSent.tenMin = true;
            }, tenMinAlert - now);
            alertTimeouts.push(timeout);
          }
        }

        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ
        if (this.calcData.alertAt5Min) {
          const fiveMinAlert = new Date(this.calcData.alertAt5Min).getTime();
          if (fiveMinAlert > now) {
            const timeout = setTimeout(() => {
              this.sendAlert('5‡∏ô‡∏≤‡∏ó‡∏µ', 'urgent');
              this.alertsSent.fiveMin = true;
            }, fiveMinAlert - now);
            alertTimeouts.push(timeout);
          }
        }
      }

      updateDisplay() {
        const now = new Date();
        const timeLeft = this.endTime.getTime() - now.getTime();
        const timeElapsed = now.getTime() - this.startTime.getTime();
        const progressPercent = Math.max(0, Math.min(100, (timeElapsed / this.originalDuration) * 100));

        if (timeLeft <= 0) {
          this.handleFinished();
          return;
        }

        const totalSecondsLeft = Math.floor(timeLeft / 1000);
        const hoursLeft = Math.floor(totalSecondsLeft / 3600);
        const minutesLeft = Math.floor((totalSecondsLeft % 3600) / 60);
        const secondsLeft = totalSecondsLeft % 60;

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const { className, statusColor, statusText } = this.getDisplayStatus(timeLeft);

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById('timeTrackingContent').innerHTML = `
          <div class="countdown-display ${className}">
            <div style="font-size: 28px; font-weight: 800;">
              ${hoursLeft}:${minutesLeft.toString().padStart(2, '0')}:${secondsLeft.toString().padStart(2, '0')}
            </div>
            <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
              ${this.formatTimeRemaining(hoursLeft, minutesLeft)}
            </div>
          </div>
          
          <div class="progress-bar">
            <div class="progress-fill ${className}" style="width: ${progressPercent.toFixed(1)}%;"></div>
          </div>
          
          <div class="tracking-details">
            ${this.generateDetailedInfo(timeLeft, progressPercent)}
          </div>
          
          <div class="tracking-controls">
            ${this.generateTrackingControls()}
          </div>
        `;

        this.updateStatusIndicator('active', statusColor, statusText);
      }

      getDisplayStatus(timeLeft) {
        if (timeLeft <= 5 * 60000) {
          return { className: 'urgent', statusColor: '#dc2626', statusText: '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï!' };
        } else if (timeLeft <= 10 * 60000) {
          return { className: 'urgent', statusColor: '#ef4444', statusText: '‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' };
        } else if (timeLeft <= 30 * 60000) {
          return { className: 'warning', statusColor: '#f59e0b', statusText: '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î' };
        } else if (timeLeft <= 60 * 60000) {
          return { className: 'warning', statusColor: '#eab308', statusText: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°' };
        } else {
          return { className: '', statusColor: '#22c55e', statusText: '‡∏õ‡∏Å‡∏ï‡∏¥' };
        }
      }

      formatTimeRemaining(hours, minutes) {
        if (hours > 0) {
          return `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        } else {
          return `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
      }

      generateDetailedInfo(timeLeft, progressPercent) {
        const flowRate = this.calcData.ccPerHr;
        const remainingVolume = (timeLeft / (1000 * 60 * 60)) * flowRate;
        const completedVolume = this.calcData.volume - remainingVolume;

        return `
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 11px; color: #64748b; text-align: center; margin: 10px 0;">
            <div>
              <div style="font-weight: 600; color: #059669;">${completedVolume.toFixed(0)} mL</div>
              <div>‡πÑ‡∏´‡∏•‡πÅ‡∏•‡πâ‡∏ß</div>
            </div>
            <div>
              <div style="font-weight: 600; color: #dc2626;">${remainingVolume.toFixed(0)} mL</div>
              <div>‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            </div>
            <div>
              <div style="font-weight: 600; color: #0ea5e9;">${progressPercent.toFixed(1)}%</div>
              <div>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
            </div>
          </div>
          <div style="text-align: center; font-size: 12px; color: #374151; margin-top: 5px;">
            üìä ‡∏≠‡∏±‡∏ï‡∏£‡∏≤: ${flowRate} cc/hr | üíß ${this.calcData.rate} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ | ‚öóÔ∏è ${this.calcData.medication}
          </div>
        `;
      }

      generateTrackingControls() {
        return `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px;">
            <button onclick="quickActionPrepareNew()" style="
              background: #22c55e; color: white; border: none; padding: 8px 12px; 
              border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600;
              display: flex; align-items: center; justify-content: center; gap: 5px;
            ">üíâ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            <button onclick="quickActionCallDoctor()" style="
              background: #ef4444; color: white; border: none; padding: 8px 12px; 
              border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600;
              display: flex; align-items: center; justify-content: center; gap: 5px;
            ">üìû ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå</button>
            <button onclick="advancedIVTracker.extendTime(30)" style="
              background: #8b5cf6; color: white; border: none; padding: 8px 12px; 
              border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600;
              display: flex; align-items: center; justify-content: center; gap: 5px;
            ">‚è∞ +30‡∏ô‡∏≤‡∏ó‡∏µ</button>
            <button onclick="advancedIVTracker.pauseTracking()" style="
              background: #64748b; color: white; border: none; padding: 8px 12px; 
              border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600;
              display: flex; align-items: center; justify-content: center; gap: 5px;
            ">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
          </div>
        `;
      }

      checkAlerts() {
        const timeLeft = this.endTime.getTime() - new Date().getTime();
        
        if (timeLeft <= 0 && !this.alertsSent.finished) {
          this.sendAlert('‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!', 'finished');
          this.alertsSent.finished = true;
        }
      }

      sendAlert(timeMsg, type) {
        const alertData = {
          bedId: bedId,
          type: 'iv_alert',
          severity: type,
          message: `üö® ‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedId} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠${timeMsg}`,
          timeLeft: timeMsg,
          patientId: this.calcData.patientId,
          medication: this.calcData.medication,
          timestamp: new Date().toISOString()
        };

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å alert
        this.saveAlert(alertData);
        
        // ‡πÅ‡∏™‡∏î‡∏á notification
        this.showNotification(alertData);
        
        // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á dashboard
        this.broadcastAlert(alertData);
      }

      saveAlert(alertData) {
        const alerts = JSON.parse(localStorage.getItem(`alerts_bed_${bedId}`) || '[]');
        alerts.unshift(alertData);
        localStorage.setItem(`alerts_bed_${bedId}`, JSON.stringify(alerts));
      }

      showNotification(alertData) {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(alertData.message, {
            icon: 'üíß',
            body: `‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${alertData.patientId} | ‡∏¢‡∏≤: ${alertData.medication}`,
          });
        } else {
          alert(alertData.message);
        }
      }

      broadcastAlert(alertData) {
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dashboard
        const globalAlerts = JSON.parse(localStorage.getItem('global_alerts') || '[]');
        globalAlerts.unshift(alertData);
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (globalAlerts.length > 100) {
          globalAlerts.splice(100);
        }
        
        localStorage.setItem('global_alerts', JSON.stringify(globalAlerts));
      }

      handleFinished() {
        this.isActive = false;
        this.clearAllIntervals();

        document.getElementById('timeTrackingContent').innerHTML = `
          <div class="countdown-display urgent" style="animation: warningPulse 1s ease-in-out infinite;">
            <div style="font-size: 32px;">üö® ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! üö®</div>
            <div style="font-size: 16px; margin-top: 10px;">‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedId} ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill urgent" style="width: 100%; animation: warningPulse 2s ease-in-out infinite;"></div>
          </div>
          <div style="text-align: center; color: #991b1b; font-weight: 600; margin: 15px 0;">
            <div>‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
            <div style="font-size: 12px; margin-top: 5px; color: #dc2626;">
              ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}
            </div>
          </div>
          <div style="text-align: center; margin-top: 10px;">
            <button onclick="stopAdvancedTimeTracking()" style="
              background: #dc2626; color: white; border: none; padding: 8px 16px; 
              border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600;
            ">‚úÖ ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
          </div>
        `;

        this.updateStatusIndicator('finished', '#dc2626', '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
        this.saveCompletedState();
      }

      pauseTracking() {
        this.isActive = false;
        alert('‚è∏Ô∏è ‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° - ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà');
      }

      resetTracking() {
        if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤?')) {
          this.stop();
          calculateAutoIV();
        }
      }

      extendTime(minutes) {
        this.endTime = new Date(this.endTime.getTime() + minutes * 60 * 1000);
        this.calcData.finishTime = this.endTime.toISOString();
        this.saveTrackingState();
        alert(`‚è∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`);
      }

      saveTrackingState() {
        const trackingState = {
          calcData: this.calcData,
          isActive: this.isActive,
          alertsSent: this.alertsSent,
          lastUpdate: new Date().toISOString()
        };
        localStorage.setItem(`iv_tracking_bed_${bedId}`, JSON.stringify(trackingState));
      }

      saveCurrentState() {
        const currentState = {
          timeLeft: this.endTime.getTime() - new Date().getTime(),
          progress: ((new Date().getTime() - this.startTime.getTime()) / this.originalDuration) * 100,
          lastUpdate: new Date().toISOString(),
          calcData: this.calcData
        };
        localStorage.setItem(`iv_current_state_bed_${bedId}`, JSON.stringify(currentState));
      }

      saveCompletedState() {
        const completedState = {
          ...this.calcData,
          completedAt: new Date().toISOString(),
          actualDuration: new Date().getTime() - this.startTime.getTime(),
          status: 'completed'
        };
        
        const completedHistory = JSON.parse(localStorage.getItem(`iv_completed_history_bed_${bedId}`) || '[]');
        completedHistory.unshift(completedState);
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (completedHistory.length > 10) {
          completedHistory.splice(10);
        }
        
        localStorage.setItem(`iv_completed_history_bed_${bedId}`, JSON.stringify(completedHistory));
      }

      updateStatusIndicator(status, color = '#22c55e', text = '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°') {
        const statusDot = document.querySelector('.status-dot');
        const statusText = document.querySelector('.status-indicator span');
        
        if (statusDot && statusText) {
          statusDot.style.background = color;
          statusText.textContent = text;
          
          if (status === 'active') {
            statusDot.classList.add('active');
          } else {
            statusDot.classList.remove('active');
          }
        }
      }

      clearAllIntervals() {
        trackingIntervals.forEach(interval => clearInterval(interval));
        alertTimeouts.forEach(timeout => clearTimeout(timeout));
        trackingIntervals = [];
        alertTimeouts = [];
      }

      stop() {
        this.isActive = false;
        this.clearAllIntervals();
        this.updateStatusIndicator('stopped', '#64748b', '‡∏´‡∏¢‡∏∏‡∏î');
        localStorage.removeItem(`iv_tracking_bed_${bedId}`);
        localStorage.removeItem(`iv_current_state_bed_${bedId}`);
      }
    }

    function startAdvancedRealTimeTracking(calcData) {
      // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
      stopAdvancedTimeTracking();
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
      advancedIVTracker = new AdvancedIVTracker(calcData);
      advancedIVTracker.start();
      
      // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå notification
      if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }

    function stopAdvancedTimeTracking() {
      if (advancedIVTracker) {
        advancedIVTracker.stop();
        advancedIVTracker = null;
      }
      
      // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
      
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
      document.getElementById('timeTrackingContent').innerHTML = `
        <div class="tracking-message">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</div>
      `;
      
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.querySelector('.status-indicator span');
      if (statusDot && statusText) {
        statusDot.classList.remove('active');
        statusDot.style.background = '#22c55e';
        statusText.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
      }
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    function quickActionPrepareNew() {
      if (!confirm('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà?')) return;
      
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      
      notes.unshift({
        content: `üö® ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà - ‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î`,
        time: new Date().toLocaleString('th-TH'),
        author: currentUser?.fullname || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        type: 'urgent_action',
        action: 'prepare_new_iv'
      });
      
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));
      
      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ Dashboard
      const globalAlerts = JSON.parse(localStorage.getItem('global_alerts') || '[]');
      globalAlerts.unshift({
        bedId: bedId,
        type: 'iv_prepared',
        message: `‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedId} - ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß`,
        timestamp: new Date().toISOString(),
        severity: 'info'
      });
      localStorage.setItem('global_alerts', JSON.stringify(globalAlerts));
      
      loadNotes();
      showQuickActionFeedback('üíâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß');
    }

    function quickActionCallDoctor() {
      if (!confirm('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå?')) return;
      
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      
      notes.unshift({
        content: `üìû ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î - ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà`,
        time: new Date().toLocaleString('th-TH'),
        author: currentUser?.fullname || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        type: 'urgent_action',
        action: 'call_doctor'
      });
      
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));
      
      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ Dashboard
      const globalAlerts = JSON.parse(localStorage.getItem('global_alerts') || '[]');
      globalAlerts.unshift({
        bedId: bedId,
        type: 'doctor_called',
        message: `‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedId} - ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß`,
        timestamp: new Date().toISOString(),
        severity: 'warning'
      });
      localStorage.setItem('global_alerts', JSON.stringify(globalAlerts));
      
      loadNotes();
      showQuickActionFeedback('üìû ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß');
    }

    function showQuickActionFeedback(message) {
      const feedback = document.createElement('div');
      feedback.innerHTML = `
        <div style="
          position: fixed; bottom: 20px; right: 20px; z-index: 9999;
          background: linear-gradient(135deg, #0ea5e9, #0284c7);
          color: white; padding: 12px 18px; border-radius: 10px;
          box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
          animation: bounceIn 0.5s ease;
          font-size: 14px; font-weight: 600;
        ">
          ${message}
        </div>
      `;
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => feedback.remove(), 500);
      }, 2000);
    }

    function triggerAdvancedNotification() {
        // Implement your advanced notification logic here
        alert('üö® ‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
    }

    function triggerNearEndNotification() {
      alert('‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!');
    }


    function refreshTimeTracking() {
      updateTimeTrackingDisplay();
    }

    function saveCalculationResults() {
      // Implement the logic to save the calculation results
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

  </script>
</body>
</html>